<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Admin ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Admin ì „ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ (index.html ìŠ¤íƒ€ì¼ ì°¨ìš©) */
      .inquiry-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 20px;
        background: #fff;
      }
      .inquiry-table th,
      .inquiry-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: center;
      }
      .inquiry-table th {
        background-color: #f8f9fa;
        color: #333;
        font-weight: 600;
      }
      .truncate-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
      }
      .detail-row {
        display: none;
        background-color: #f9f9f9;
      }
      .detail-cell {
        padding: 0 !important;
        border-bottom: 1px solid #ddd;
      }
      .detail-content {
        padding: 20px;
        text-align: left;
        border-left: 4px solid #008b8b;
      }
      .reply-textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .btn-inline {
        padding: 8px 16px;
        background-color: #008b8b;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-inline:hover {
        background-color: #007a7a;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Admin ëŒ€ì‹œë³´ë“œ</h1>

      <section id="admin-login">
        <h2>Admin ì¸ì¦</h2>
        <form id="adminLoginForm">
          <div class="form-group">
            <label for="adminPassword">Admin ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="adminPassword" required />
          </div>
          <button type="submit" class="btn-submit">ë¡œê·¸ì¸</button>
        </form>
      </section>

      <section id="admin-panel" style="display: none">
        <h2>ë¯¸ë‹µë³€ ë¬¸ì˜ ëª©ë¡</h2>
        <table class="inquiry-table">
          <thead>
            <tr>
              <th style="width: 10%">ID</th>
              <th style="width: 50%">ë¬¸ì˜ë‚´ìš©</th>
              <th style="width: 20%">ì‘ì„±ì</th>
              <th style="width: 20%">ì‘ì„±ì¼</th>
            </tr>
          </thead>
          <tbody id="pendingListBody"></tbody>
        </table>
      </section>
    </div>

    <script>
      const API_BASE = "/.netlify/functions";
      let adminPassword = "";

      // Admin ë¡œê·¸ì¸
      document
        .getElementById("adminLoginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const inputPassword = document.getElementById("adminPassword").value;

          if (inputPassword === "admin1234") {
            adminPassword = inputPassword;
            document.getElementById("admin-login").style.display = "none";
            document.getElementById("admin-panel").style.display = "block";
            loadPendingInquiries();
          } else {
            alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        });

      // ë¯¸ë‹µë³€ ë¬¸ì˜ ì¡°íšŒ
      async function loadPendingInquiries() {
        try {
          const response = await fetch(
            `${API_BASE}/get-public-list?getAll=true`
          );
          const inquiries = await response.json();

          const pending = inquiries.filter((q) => !q.reply);
          const tbody = document.getElementById("pendingListBody");
          tbody.innerHTML = "";

          if (pending.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="padding:20px;">ë¯¸ë‹µë³€ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
          }

          pending.forEach((q) => {
            // 1. ìš”ì•½ í–‰
            const tr = document.createElement("tr");
            tr.style.cursor = "pointer";
            tr.onclick = () => toggleDetail(q.id);
            tr.innerHTML = `
              <td>${q.id}</td>
              <td><div class="truncate-text">${sanitizeHTML(
                q.message
              )}</div></td>
              <td>${q.name}</td>
              <td>${new Date(q.created_at).toLocaleDateString("ko-KR")}</td>
            `;
            tbody.appendChild(tr);

            // 2. ìƒì„¸ ë° ë‹µë³€ ì‘ì„± í–‰
            const detailTr = document.createElement("tr");
            detailTr.id = `detail-${q.id}`;
            detailTr.className = "detail-row";
            detailTr.innerHTML = `
              <td colspan="4" class="detail-cell">
                <div class="detail-content">
                  <p><strong>ğŸ“ ë¬¸ì˜ ìƒì„¸ ë‚´ìš©:</strong></p>
                  <div style="margin: 10px 0; white-space: pre-wrap; color: #333;">${sanitizeHTML(
                    q.message
                  )}</div>
                  <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                  <p><strong>ğŸ’¬ ë‹µë³€ ì‘ì„±:</strong></p>
                  <textarea id="reply-text-${
                    q.id
                  }" class="reply-textarea" placeholder="ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                  <button class="btn-inline" onclick="submitReply(${
                    q.id
                  })">ë‹µë³€ ë“±ë¡</button>
                </div>
              </td>
            `;
            tbody.appendChild(detailTr);
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // ìƒì„¸ í† ê¸€
      function toggleDetail(id) {
        const row = document.getElementById(`detail-${id}`);
        row.style.display = row.style.display === "none" ? "table-row" : "none";
      }

      // ë‹µë³€ ë“±ë¡ (ì¸ë¼ì¸)
      async function submitReply(id) {
        const replyText = document.getElementById(`reply-text-${id}`).value;
        if (!replyText.trim()) {
          alert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        if (!confirm("ë‹µë³€ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const data = {
          id: id,
          adminPassword,
          reply: replyText,
        };

        try {
          const response = await fetch(`${API_BASE}/admin-reply`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (response.ok) {
            alert("âœ“ ë‹µê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤");
            loadPendingInquiries();
          } else {
            alert(`âœ— ${result.error}`);
          }
        } catch (error) {
          alert(`âœ— ì˜¤ë¥˜: ${error.message}`);
        }
      }

      // ìœ í‹¸ë¦¬í‹°: HTML ì‚´ê·  (XSS ë°©ì§€)
      function sanitizeHTML(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
