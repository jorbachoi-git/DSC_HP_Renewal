<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë™ì„œí™”í•™ í™ˆí˜ì´ì§€ Admin ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Admin ì „ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ (index.html ìŠ¤íƒ€ì¼ ì°¨ìš©) */
      .inquiry-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        margin-bottom: 20px;
        background: #fff;
      }
      .inquiry-table th,
      .inquiry-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: center;
      }
      .inquiry-table th {
        background-color: #f8f9fa;
        color: #333;
        font-weight: 600;
      }
      .truncate-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
      }
      .detail-row {
        display: none;
        background-color: #f9f9f9;
      }
      .detail-cell {
        padding: 0 !important;
        border-bottom: 1px solid #ddd;
      }
      .detail-content {
        padding: 20px;
        text-align: left;
        border-left: 4px solid #008b8b;
      }
      .reply-textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .btn-inline {
        padding: 8px 16px;
        background-color: #008b8b;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-inline:hover {
        background-color: #007a7a;
      }
      /* Admin ìƒë‹¨ ë°°ë„ˆ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
      .admin-banner {
        width: 100%;
        height: 45vh; /* í™”ë©´ ë†’ì´ì˜ 45% ì°¨ì§€ */
        background-image: url("images/BGI_DongSuh1.png");
        background-size: cover;
        background-position: center;
        margin-bottom: 40px;
        border-bottom: 5px solid #008b8b;
        transition: all 0.5s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
      }
      /* ë¡œê·¸ì¸ í›„ ë°°ë„ˆ ìŠ¤íƒ€ì¼ ë³€ê²½ */
      .admin-banner.logged-in {
        height: 20vh; /* ë†’ì´ 20%ë¡œ ì¶•ì†Œ */
        background-image: url("images/BGI_DongSuh2.png"); /* ì´ë¯¸ì§€ ë³€ê²½ */
        margin-bottom: 20px;
      }
      /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ íŒì—… ìŠ¤íƒ€ì¼ */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.active {
        display: flex;
      }
      .custom-modal {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 400px;
        text-align: center;
        animation: popIn 0.3s ease;
      }
      @keyframes popIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .custom-modal h3 {
        margin-top: 0;
        color: #008b8b;
        margin-bottom: 15px;
        font-size: 1.3rem;
      }
      .custom-modal p {
        color: #555;
        margin-bottom: 25px;
        font-size: 1.05rem;
        line-height: 1.5;
      }
      .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .btn-modal-confirm {
        background-color: #008b8b;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
        transition: background 0.2s;
      }
      .btn-modal-confirm:hover {
        background-color: #007a7a;
      }
      .btn-modal-cancel {
        background-color: #e0e0e0;
        color: #333;
        border: none;
        padding: 10px 25px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1rem;
        transition: background 0.2s;
      }
      .btn-modal-cancel:hover {
        background-color: #d0d0d0;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }
    </style>
  </head>
  <body>
    <!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ íŒì—… HTML -->
    <div id="customModalOverlay" class="modal-overlay">
      <div class="custom-modal">
        <h3 id="customModalTitle">ì•Œë¦¼</h3>
        <p id="customModalMessage">ë©”ì‹œì§€ ë‚´ìš©</p>
        <div class="modal-buttons">
          <button id="btnModalConfirm" class="btn-modal-confirm">í™•ì¸</button>
          <button id="btnModalCancel" class="btn-modal-cancel">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <div class="admin-banner"></div>
    <div class="container">
      <h1>ë™ì„œí™”í•™ í™ˆí˜ì´ì§€ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>

      <section id="admin-login">
        <h2>ê´€ë¦¬ì ì¸ì¦</h2>
        <form id="adminLoginForm">
          <div class="form-group">
            <label for="adminPassword">Admin ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="adminPassword" required />
          </div>
          <button type="submit" class="btn-submit">ë¡œê·¸ì¸</button>
        </form>
      </section>

      <section id="admin-panel" style="display: none">
        <h2>ë¯¸ë‹µë³€ ë¬¸ì˜ ëª©ë¡</h2>
        <table class="inquiry-table">
          <thead>
            <tr>
              <th style="width: 10%">ID</th>
              <th style="width: 50%">ë¬¸ì˜ë‚´ìš©</th>
              <th style="width: 20%">ì‘ì„±ì</th>
              <th style="width: 20%">ì‘ì„±ì¼</th>
            </tr>
          </thead>
          <tbody id="pendingListBody"></tbody>
        </table>
      </section>
    </div>

    <script>
      const API_BASE = "/.netlify/functions";
      let adminPassword = "";

      // Admin ë¡œê·¸ì¸
      document
        .getElementById("adminLoginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const inputPassword = document.getElementById("adminPassword").value;

          if (inputPassword === "admin1234") {
            adminPassword = inputPassword;
            document.getElementById("admin-login").style.display = "none";
            document.getElementById("admin-panel").style.display = "block";

            // ë¡œê·¸ì¸ í›„ ë°°ë„ˆ ìŠ¤íƒ€ì¼ ë³€ê²½ (ë†’ì´ ì¶•ì†Œ ë° ì´ë¯¸ì§€ ë³€ê²½)
            document.querySelector(".admin-banner").classList.add("logged-in");

            loadPendingInquiries();
          } else {
            alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
        });

      // ë¯¸ë‹µë³€ ë¬¸ì˜ ì¡°íšŒ
      async function loadPendingInquiries() {
        try {
          const response = await fetch(
            `${API_BASE}/get-public-list?getAll=true`
          );
          const inquiries = await response.json();

          const pending = inquiries.filter((q) => !q.reply);
          const tbody = document.getElementById("pendingListBody");
          tbody.innerHTML = "";

          if (pending.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="padding:20px;">ë¯¸ë‹µë³€ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
          }

          pending.forEach((q) => {
            // 1. ìš”ì•½ í–‰
            const tr = document.createElement("tr");
            tr.style.cursor = "pointer";
            tr.onclick = () => toggleDetail(q.id);
            tr.innerHTML = `
              <td>${q.id}</td>
              <td><div class="truncate-text">${sanitizeHTML(
                q.message
              )}</div></td>
              <td>${q.name}</td>
              <td>${new Date(q.created_at).toLocaleDateString("ko-KR")}</td>
            `;
            tbody.appendChild(tr);

            // 2. ìƒì„¸ ë° ë‹µë³€ ì‘ì„± í–‰
            const detailTr = document.createElement("tr");
            detailTr.id = `detail-${q.id}`;
            detailTr.className = "detail-row";
            detailTr.innerHTML = `
              <td colspan="4" class="detail-cell">
                <div class="detail-content">
                  <p><strong>ğŸ“ ë¬¸ì˜ ìƒì„¸ ë‚´ìš©:</strong></p>
                  <div style="margin: 10px 0; white-space: pre-wrap; color: #333;">${sanitizeHTML(
                    q.message
                  )}</div>
                  <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                  <p><strong>ğŸ’¬ ë‹µë³€ ì‘ì„±:</strong></p>
                  <textarea id="reply-text-${
                    q.id
                  }" class="reply-textarea" placeholder="ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                  <button class="btn-inline" onclick="submitReply(${
                    q.id
                  })">ë‹µë³€ ë“±ë¡</button>
                </div>
              </td>
            `;
            tbody.appendChild(detailTr);
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // ìƒì„¸ í† ê¸€
      function toggleDetail(id) {
        const row = document.getElementById(`detail-${id}`);
        row.style.display = row.style.display === "none" ? "table-row" : "none";
      }

      // ë‹µë³€ ë“±ë¡ (ì¸ë¼ì¸)
      function submitReply(id) {
        const replyText = document.getElementById(`reply-text-${id}`).value;
        if (!replyText.trim()) {
          showCustomAlert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ì»¤ìŠ¤í…€ í™•ì¸ íŒì—… í˜¸ì¶œ
        showCustomConfirm("ë‹µë³€ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", async () => {
          const data = {
            id: id,
            adminPassword,
            reply: replyText,
          };

          try {
            const response = await fetch(`${API_BASE}/admin-reply`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (response.ok) {
              // ì„±ê³µ ì‹œ ì»¤ìŠ¤í…€ ì•Œë¦¼ íŒì—…
              showCustomAlert("ë‹µë³€ì´ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤", () => {
                loadPendingInquiries();
              });
            } else {
              showCustomAlert(`âœ— ${result.error}`);
            }
          } catch (error) {
            showCustomAlert(`âœ— ì˜¤ë¥˜: ${error.message}`);
          }
        });
      }

      // --- ì»¤ìŠ¤í…€ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---
      function showCustomConfirm(message, onConfirm) {
        const overlay = document.getElementById("customModalOverlay");
        const title = document.getElementById("customModalTitle");
        const msg = document.getElementById("customModalMessage");
        const btnConfirm = document.getElementById("btnModalConfirm");
        const btnCancel = document.getElementById("btnModalCancel");

        title.textContent = "í™•ì¸";
        msg.textContent = message;
        btnCancel.style.display = "inline-block"; // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ê¸°

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” (ì¤‘ë³µ ë°©ì§€)
        const newConfirmBtn = btnConfirm.cloneNode(true);
        const newCancelBtn = btnCancel.cloneNode(true);
        btnConfirm.parentNode.replaceChild(newConfirmBtn, btnConfirm);
        btnCancel.parentNode.replaceChild(newCancelBtn, btnCancel);

        newConfirmBtn.addEventListener("click", () => {
          closeCustomModal();
          if (onConfirm) onConfirm();
        });
        newCancelBtn.addEventListener("click", closeCustomModal);

        overlay.classList.add("active");
      }

      function showCustomAlert(message, onOk) {
        const overlay = document.getElementById("customModalOverlay");
        const title = document.getElementById("customModalTitle");
        const msg = document.getElementById("customModalMessage");
        const btnConfirm = document.getElementById("btnModalConfirm");
        const btnCancel = document.getElementById("btnModalCancel");

        title.textContent = "ì•Œë¦¼";
        msg.textContent = message;
        btnCancel.style.display = "none"; // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°

        const newConfirmBtn = btnConfirm.cloneNode(true);
        btnConfirm.parentNode.replaceChild(newConfirmBtn, btnConfirm);

        newConfirmBtn.addEventListener("click", () => {
          closeCustomModal();
          if (onOk) onOk();
        });

        overlay.classList.add("active");
      }

      function closeCustomModal() {
        document
          .getElementById("customModalOverlay")
          .classList.remove("active");
      }

      // ìœ í‹¸ë¦¬í‹°: HTML ì‚´ê·  (XSS ë°©ì§€)
      function sanitizeHTML(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
